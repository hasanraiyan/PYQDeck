<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Q&A Editor (jQuery)</title>
    <!-- Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for Icons via CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <!-- jQuery via CDN -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
    <style>
        /* Base styles */
        body { background-color: #f3f4f6; /* gray-100 */ font-family: sans-serif; }
        /* JSON output styling */
        #json-output { background-color: #1f2937; color: #d1d5db; border-radius: 0.375rem; padding: 1rem; font-family: monospace; font-size: 0.875rem; line-height: 1.25rem; white-space: pre-wrap; word-wrap: break-word; max-height: 85vh; overflow: auto; }
        /* Modal styles */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.6); display: flex; align-items: center; justify-content: center; z-index: 50; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease; }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal-content { background-color: white; padding: 1.5rem 2rem; border-radius: 0.5rem; max-width: 90%; width: 550px; /* Slightly wider */ max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 25px rgba(0,0,0,0.1); transform: scale(0.95); transition: transform 0.3s ease; }
        .modal-overlay.active .modal-content { transform: scale(1); }
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #e5e7eb; border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: #9ca3af; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        /* Hide elements meant for specific contexts */
        .form-field.hidden { display: none; }
        /* Action button styling */
        .action-btn { background: none; border: none; cursor: pointer; padding: 5px; border-radius: 50%; line-height: 1; display: inline-flex; align-items: center; justify-content: center; width: 24px; height: 24px; }
        .action-btn:hover { background-color: rgba(0,0,0,0.08); }
        .action-btn .fa-trash-alt { color: #ef4444; /* red-500 */ }
        .action-btn .fa-pencil-alt { color: #3b82f6; /* blue-500 */ }
        .action-btn .fa-plus { color: #10b981; /* emerald-500 */ }
        .action-btn .fas { font-size: 0.8rem; /* Smaller icons */ }
        /* Question completion toggle */
        .toggle-dot { transition: transform 0.2s ease-in-out; }
    </style>
</head>
<body class="flex flex-col lg:flex-row gap-6 p-6 min-h-screen">

    <!-- Editor Panel -->
    <div id="editor-container" class="w-full lg:w-3/5 bg-white p-5 rounded-lg shadow-lg overflow-y-auto max-h-[90vh]">
        <div class="flex justify-between items-center mb-4 border-b pb-3">
            <h2 class="text-2xl font-bold text-gray-800">Editor</h2>
            <button id="add-branch-main-btn"
                class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
            >
                <i class="fas fa-plus -ml-1 mr-2"></i> Add Branch
            </button>
        </div>
        <div id="branches-list" class="space-y-6">
            <!-- Dynamic Content Rendered Here -->
            <p class="text-gray-500 text-center py-10">No branches added yet. Click "Add Branch" to start.</p>
        </div>
    </div>

    <!-- JSON Output Panel -->
    <div id="json-output-container" class="w-full lg:w-2/5">
        <h2 class="text-2xl font-bold text-gray-800 mb-4">Live JSON Output</h2>
        <pre id="json-output">{}</pre>
         <button id="save-local-btn" class="mt-4 mr-2 px-4 py-2 bg-blue-500 text-white text-sm rounded hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-400">Save</button>
         <button id="load-local-btn" class="mt-4 px-4 py-2 bg-gray-500 text-white text-sm rounded hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400">Load</button>
    </div>

    <!-- Modal Structure (Hidden by default) -->
    <div id="item-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="modal-title" class="text-xl font-semibold mb-5 text-gray-900">Add/Edit Item</h3>
            <form id="modal-form" class="space-y-4">
                <!-- Hidden fields for context -->
                <input type="hidden" id="edit-mode">
                <input type="hidden" id="edit-indices"> <!-- Stores stringified JSON indices -->

                <!-- Common Fields -->
                <div class="form-field" data-context="branch semester subject question">
                    <label for="item-id" class="block text-sm font-medium text-gray-700">ID *</label>
                    <input type="text" id="item-id" name="id" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                </div>
                <div class="form-field" data-context="branch subject">
                    <label for="item-name" class="block text-sm font-medium text-gray-700">Name *</label>
                    <input type="text" id="item-name" name="name" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                </div>
                <!-- Semester Specific -->
                <div class="form-field" data-context="semester">
                    <label for="item-number" class="block text-sm font-medium text-gray-700">Semester Number *</label>
                    <input type="number" id="item-number" name="number" required min="1" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                </div>
                <!-- Subject Specific -->
                <div class="form-field" data-context="subject">
                    <label for="item-code" class="block text-sm font-medium text-gray-700">Subject Code *</label>
                    <input type="text" id="item-code" name="code" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                </div>
                <!-- Question Specific Fields -->
                <div class="form-field" data-context="question">
                    <label for="item-year" class="block text-sm font-medium text-gray-700">Year *</label>
                    <input type="number" id="item-year" name="year" required min="1900" max="2100" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                </div>
                 <div class="form-field" data-context="question">
                    <label for="item-qNumber" class="block text-sm font-medium text-gray-700">Question Number (e.g., Q1a) *</label>
                    <input type="text" id="item-qNumber" name="qNumber" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                </div>
                <div class="form-field" data-context="question">
                    <label for="item-chapter" class="block text-sm font-medium text-gray-700">Chapter/Module *</label>
                    <input type="text" id="item-chapter" name="chapter" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                </div>
                 <div class="form-field" data-context="question">
                    <label for="item-text" class="block text-sm font-medium text-gray-700">Question Text (Markdown supported) *</label>
                    <textarea id="item-text" name="text" required rows="5" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></textarea>
                    <p class="mt-1 text-xs text-gray-500">Use ```lang\\n...``` for code, ![alt](url) for images.</p>
                </div>
                <div class="form-field" data-context="question">
                    <label for="item-type" class="block text-sm font-medium text-gray-700">Question Type *</label>
                    <input type="text" id="item-type" name="type" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                </div>
                 <div class="form-field" data-context="question">
                    <label for="item-marks" class="block text-sm font-medium text-gray-700">Marks *</label>
                    <input type="number" id="item-marks" name="marks" required min="0" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                </div>

                <!-- Action Buttons -->
                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" id="modal-cancel-btn" class="px-4 py-2 bg-gray-200 text-gray-800 text-sm font-medium rounded-md hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500">
                        Cancel
                    </button>
                    <button type="submit" id="modal-submit-button" class="px-4 py-2 bg-indigo-600 text-white text-sm font-medium rounded-md shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        Save
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
    $(document).ready(function() { // Ensure DOM is ready

        // --- Constants & State ---
        const CODE_BLOCK_REGEX = /```(\w+)?\s*\n([\s\S]*?)\n?```/g;
        const IMAGE_REGEX = /!\[([^\]]*)\]\(([^)]+)\)/g;
        const QUESTION_ID_REGEX = /^(Q\d+[a-z]?\s*:)\s*/i;
        const LOCAL_STORAGE_KEY = 'universityQuestionData_v2'; // Use new key

        let universityData = { branches: [] };
        let currentModalContext = null;
        let isEditMode = false;
        let currentEditIndices = {}; // Use object for indices { branchIndex, semesterIndex, ... }

        // --- jQuery Objects ---
        const $modal = $('#item-modal');
        const $modalForm = $('#modal-form');
        const $modalTitle = $('#modal-title');
        const $modalSubmitButton = $('#modal-submit-button');
        const $branchesListDiv = $('#branches-list');
        const $jsonOutputPre = $('#json-output');
        const $allFormFields = $modalForm.find('.form-field');

        // --- Utility Functions ---
        function sanitizeInput(str = '') {
            // Basic sanitization, consider a library like DOMPurify for production
            const temp = document.createElement('div');
            temp.textContent = str;
            return temp.innerHTML;
        }

        function capitalizeFirstLetter(string) {
            if (!string) return '';
            return string.charAt(0).toUpperCase() + string.slice(1);
        }

        // --- Parsing & Rendering HTML for Content ---
        function parseContent(text = '') {
             if (!text) return [{ type: 'text', content: '[No Content]' }];
            const parts = []; let lastIndex = 0; let match; const sourceText = text;
            const imagePlaceholders = {}; let placeholderIndex = 0;
            const textWithoutImages = sourceText.replace(IMAGE_REGEX, (fullMatch, alt, uri) => {
                const placeholder = `__IMAGE_PLACEHOLDER_${placeholderIndex++}__`; imagePlaceholders[placeholder] = { type: 'image', alt, uri }; return placeholder;
            });
            while ((match = CODE_BLOCK_REGEX.exec(textWithoutImages)) !== null) {
                if (match.index > lastIndex) { let textPart = textWithoutImages.substring(lastIndex, match.index).trim(); textPart = restoreImagesInText(textPart, imagePlaceholders, parts); const cleanedTextPart = textPart.replace(QUESTION_ID_REGEX, '').trim(); if (cleanedTextPart && !cleanedTextPart.startsWith('__IMAGE_PLACEHOLDER_')) parts.push({ type: 'text', content: cleanedTextPart }); }
                const language = match[1] || 'plaintext'; const codeContent = match[2].trim(); if (codeContent) parts.push({ type: 'code', language: language.toLowerCase(), content: codeContent }); lastIndex = CODE_BLOCK_REGEX.lastIndex;
            }
            if (lastIndex < textWithoutImages.length) { let remainingText = textWithoutImages.substring(lastIndex).trim(); remainingText = restoreImagesInText(remainingText, imagePlaceholders, parts); const cleanedRemainingText = remainingText.replace(QUESTION_ID_REGEX, '').trim(); if (cleanedRemainingText && !cleanedRemainingText.startsWith('__IMAGE_PLACEHOLDER_')) parts.push({ type: 'text', content: cleanedRemainingText }); }
            restoreImagesInText('', imagePlaceholders, parts);
            if (parts.length === 0 && sourceText.match(QUESTION_ID_REGEX)) {}
            else if (parts.length === 0 && lastIndex === 0) { let fullTextPart = textWithoutImages.trim(); fullTextPart = restoreImagesInText(fullTextPart, imagePlaceholders, parts); const cleanedFullText = fullTextPart.replace(QUESTION_ID_REGEX, '').trim(); if (cleanedFullText && !cleanedFullText.startsWith('__IMAGE_PLACEHOLDER_')) parts.push({ type: 'text', content: cleanedFullText }); restoreImagesInText('', imagePlaceholders, parts); }
            if (parts.length === 0) return [{ type: 'text', content: '[Question content appears empty or is only formatting]' }];
            return parts;
        }

        function restoreImagesInText(textSegment, imagePlaceholders, partsArray) {
            let currentSegment = textSegment; const placeholderRegex = /__IMAGE_PLACEHOLDER_(\d+)__/g; let match; let lastTextIndex = 0;
            while ((match = placeholderRegex.exec(currentSegment)) !== null) {
                if (match.index > lastTextIndex) { const textBefore = currentSegment.substring(lastTextIndex, match.index).trim(); if (textBefore) partsArray.push({ type: 'text', content: textBefore }); }
                const placeholder = match[0]; if (imagePlaceholders[placeholder]) { partsArray.push(imagePlaceholders[placeholder]); delete imagePlaceholders[placeholder]; } lastTextIndex = placeholderRegex.lastIndex;
            }
            if (lastTextIndex < currentSegment.length) { const textAfter = currentSegment.substring(lastTextIndex).trim(); if (textAfter) partsArray.push({ type: 'text', content: textAfter }); } return '';
        }

        function renderHtmlForPart(part, index) {
             switch (part.type) {
                case 'text': return `<p class="text-gray-700 mb-2 text-sm leading-relaxed">${sanitizeInput(part.content)}</p>`;
                case 'code': return `<div class="my-3"><pre class="bg-gray-800 text-gray-200 text-xs font-mono p-3 rounded-md overflow-x-auto"><code>${sanitizeInput(part.content)}</code></pre></div>`;
                case 'image': const imageUrl = part.uri && part.uri.includes('https://image.pollinations.ai/prompt/') ? part.uri : `https://image.pollinations.ai/prompt/${encodeURIComponent(part.alt || 'placeholder image')}`; return `<img src="${sanitizeInput(imageUrl)}" alt="${sanitizeInput(part.alt || 'image')}" class="my-3 rounded-lg border border-gray-200 max-w-full h-auto block" style="max-height: 250px;">`;
                default: return '';
            }
        }

        // --- UI Rendering Functions ---
        function renderEditor() {
            $branchesListDiv.empty(); // Clear previous content using jQuery

            if (!universityData.branches || universityData.branches.length === 0) {
                 $branchesListDiv.html('<p class="text-gray-500 text-center py-10">No branches added yet. Click "Add Branch" to start.</p>');
                 updateJsonOutput();
                 return;
            }

            universityData.branches.forEach((branch, branchIndex) => {
                const branchHtml = `
                    <div class="p-4 border border-gray-200 rounded-lg bg-white shadow-sm">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="text-lg font-semibold text-gray-800 truncate mr-2" title="${sanitizeInput(branch.name)}">${sanitizeInput(branch.name)} <code class="text-sm text-gray-500 font-normal">(${sanitizeInput(branch.id)})</code></h3>
                            <div class="flex space-x-1 flex-shrink-0">
                                <button class="action-btn add-semester-btn" data-branch-index="${branchIndex}" title="Add Semester"> <i class="fas fa-plus"></i> </button>
                                <button class="action-btn edit-item-btn" data-context="branch" data-indices='${JSON.stringify({ branchIndex })}' title="Edit Branch"> <i class="fas fa-pencil-alt"></i> </button>
                                <button class="action-btn delete-item-btn" data-context="branch" data-indices='${JSON.stringify({ branchIndex })}' title="Delete Branch"> <i class="fas fa-trash-alt"></i> </button>
                            </div>
                        </div>
                        <div class="semesters-list space-y-4 pl-4 border-l-2 border-gray-200 ml-1" id="semesters-list-${branchIndex}">
                            ${renderSemesters(branchIndex)} <!-- Render nested content -->
                        </div>
                    </div>`;
                $branchesListDiv.append(branchHtml);
            });
            updateJsonOutput();
        }

        function renderSemesters(branchIndex) {
            const branch = universityData.branches[branchIndex];
            if (!branch || !branch.semesters || branch.semesters.length === 0) return '<p class="text-xs text-gray-400 pl-1 pt-1">No semesters added.</p>';

            let semestersHtml = '';
            branch.semesters.forEach((semester, semesterIndex) => {
                semestersHtml += `
                    <div class="p-3 border border-gray-200 rounded-md bg-gray-50 shadow-xs">
                        <div class="flex justify-between items-center mb-2">
                            <h4 class="text-md font-medium text-gray-700">Semester: ${sanitizeInput(semester.number)} <code class="text-xs text-gray-500 font-normal">(${sanitizeInput(semester.id)})</code></h4>
                             <div class="flex space-x-1 flex-shrink-0">
                                <button class="action-btn add-subject-btn" data-branch-index="${branchIndex}" data-semester-index="${semesterIndex}" title="Add Subject"> <i class="fas fa-plus"></i> </button>
                                <button class="action-btn edit-item-btn" data-context="semester" data-indices='${JSON.stringify({ branchIndex, semesterIndex })}' title="Edit Semester"> <i class="fas fa-pencil-alt"></i> </button>
                                <button class="action-btn delete-item-btn" data-context="semester" data-indices='${JSON.stringify({ branchIndex, semesterIndex })}' title="Delete Semester"> <i class="fas fa-trash-alt"></i> </button>
                            </div>
                        </div>
                        <div class="subjects-list space-y-3 pl-3 border-l border-gray-300 ml-1" id="subjects-list-${branchIndex}-${semesterIndex}">
                            ${renderSubjects(branchIndex, semesterIndex)}
                        </div>
                    </div>`;
            });
            return semestersHtml;
        }

        function renderSubjects(branchIndex, semesterIndex) {
            const semester = universityData.branches[branchIndex]?.semesters[semesterIndex];
             if (!semester || !semester.subjects || semester.subjects.length === 0) return '<p class="text-xs text-gray-400 pl-1 pt-1">No subjects added.</p>';

            let subjectsHtml = '';
            semester.subjects.forEach((subject, subjectIndex) => {
                subjectsHtml += `
                    <div class="p-3 border border-dashed border-gray-300 rounded-md bg-white">
                         <div class="flex justify-between items-center mb-2">
                            <h5 class="text-sm font-semibold text-indigo-800 truncate mr-2" title="${sanitizeInput(subject.name)} (${sanitizeInput(subject.code)})">${sanitizeInput(subject.name)} <code class="text-xs text-gray-500 font-normal">(${sanitizeInput(subject.code)} / ${sanitizeInput(subject.id)})</code></h5>
                            <div class="flex space-x-1 flex-shrink-0">
                                <button class="action-btn add-question-btn" data-branch-index="${branchIndex}" data-semester-index="${semesterIndex}" data-subject-index="${subjectIndex}" title="Add Question"> <i class="fas fa-plus"></i> </button>
                                <button class="action-btn edit-item-btn" data-context="subject" data-indices='${JSON.stringify({ branchIndex, semesterIndex, subjectIndex })}' title="Edit Subject"> <i class="fas fa-pencil-alt"></i> </button>
                                <button class="action-btn delete-item-btn" data-context="subject" data-indices='${JSON.stringify({ branchIndex, semesterIndex, subjectIndex })}' title="Delete Subject"> <i class="fas fa-trash-alt"></i> </button>
                            </div>
                        </div>
                        <div class="questions-list space-y-4" id="questions-list-${branchIndex}-${semesterIndex}-${subjectIndex}">
                           ${renderQuestions(branchIndex, semesterIndex, subjectIndex)}
                        </div>
                    </div>`;
            });
             return subjectsHtml;
        }

        function renderQuestions(branchIndex, semesterIndex, subjectIndex) {
             const subject = universityData.branches[branchIndex]?.semesters[semesterIndex]?.subjects[subjectIndex];
             if (!subject || !subject.questions || subject.questions.length === 0) return '<p class="text-xs text-gray-400 pl-1 pt-2">No questions added.</p>';

             let questionsHtml = '';
             subject.questions.forEach((question, questionIndex) => {
                 const indices = { branchIndex, semesterIndex, subjectIndex, questionIndex };
                 const parsedContent = parseContent(question.text);
                 const bodyHtml = parsedContent.map(renderHtmlForPart).join('');
                 const displayChapter = (question.chapter || '').replace(/^Module\s*\d+:\s*/i, '').trim();

                 questionsHtml += `
                    <div class="question-card bg-white rounded-lg shadow-sm overflow-hidden border ${question.isCompleted ? 'border-l-4 border-green-500' : 'border-gray-200'}">
                        <!-- Header -->
                        <div class="flex justify-between items-start p-3 border-b border-gray-100 bg-gray-50/70">
                            <div class="text-xs font-medium text-gray-600">
                                ${sanitizeInput(question.year) || 'N/A'} - ${sanitizeInput(question.qNumber) || '?'}
                                <p class="text-xs text-gray-400 font-normal mt-0.5">${sanitizeInput(question.questionId)}</p>
                            </div>
                            <div class="flex items-center">
                                ${displayChapter ? `<span class="inline-block bg-purple-100 text-purple-800 text-xs font-semibold px-2 py-0.5 rounded-full text-right max-w-[150px] truncate mr-2" title="${sanitizeInput(displayChapter)}">${sanitizeInput(displayChapter)}</span>` : ''}
                                <div class="flex space-x-1 flex-shrink-0">
                                    <button class="action-btn edit-item-btn" data-context="question" data-indices='${JSON.stringify(indices)}' title="Edit Question"> <i class="fas fa-pencil-alt"></i> </button>
                                    <button class="action-btn delete-item-btn" data-context="question" data-indices='${JSON.stringify(indices)}' title="Delete Question"> <i class="fas fa-trash-alt"></i> </button>
                                </div>
                            </div>
                        </div>
                        <!-- Body -->
                        <div class="p-4 text-sm">${bodyHtml}</div>
                        <!-- Footer -->
                        <div class="flex flex-wrap justify-between items-center p-3 border-t border-gray-100 bg-gray-50/70">
                            <div class="flex flex-wrap items-center mb-2 sm:mb-0">
                                ${question.type ? `<span class="inline-block bg-blue-100 text-blue-800 text-xs font-medium mr-2 mb-1 px-2 py-0.5 rounded-full">${sanitizeInput(question.type)}</span>` : ''}
                                ${(question.marks !== null && question.marks !== undefined && question.marks !== '') ? `<span class="inline-block bg-green-100 text-green-800 text-xs font-medium mr-2 mb-1 px-2 py-0.5 rounded-full">${sanitizeInput(question.marks)} Marks</span>` : ''}
                            </div>
                            <div class="flex items-center space-x-3">
                                <button class="ask-ai-btn inline-flex items-center bg-indigo-100 text-indigo-700 text-xs font-medium px-2.5 py-1 rounded-full hover:bg-indigo-200" data-question='${sanitizeInput(JSON.stringify(question))}'> <i class="fas fa-robot mr-1.5 text-xs"></i> Ask AI </button>
                                <div class="toggle-completion-btn relative inline-block w-10 h-5 align-middle select-none transition duration-200 ease-in cursor-pointer" data-indices='${JSON.stringify(indices)}' title="Toggle Completion">
                                    <div class="toggle-bg ${question.isCompleted ? 'bg-green-500' : 'bg-gray-300'} absolute block w-full h-full rounded-full"></div>
                                    <div class="toggle-dot absolute left-0 top-0 bg-white w-5 h-5 rounded-full shadow transform transition-transform duration-200 ease-in ${question.isCompleted ? 'translate-x-5' : 'translate-x-0'}"></div>
                                </div>
                            </div>
                        </div>
                    </div>`;
             });
             return questionsHtml;
         }

        function updateJsonOutput() {
            const dataToDisplay = JSON.parse(JSON.stringify(universityData, (key, value) => {
                // Keep isCompleted in JSON output for persistence if desired
                // if (key === 'isCompleted') return undefined; // Uncomment to EXCLUDE from JSON
                return value;
            }));
            $jsonOutputPre.text(JSON.stringify(dataToDisplay, null, 2));
        }

        // --- Modal Management ---
        function showModal(context, indices = {}) {
            currentModalContext = context;
            isEditMode = indices && Object.keys(indices).length > 0 && (indices.branchIndex !== undefined);
            currentEditIndices = indices;

            $modalForm[0].reset(); // Use [0] to access the native form element for reset
            $modalForm.find('#edit-mode').val(isEditMode ? 'edit' : 'add');
            $modalForm.find('#edit-indices').val(JSON.stringify(indices));

            $modalTitle.text(`${isEditMode ? 'Edit' : 'Add'} ${capitalizeFirstLetter(context)}`);
            $modalSubmitButton.text(isEditMode ? 'Update' : 'Add');

            // Show/Hide fields based on context and manage required/disabled states
            $allFormFields.each(function() {
                const $field = $(this);
                const fieldContexList = $field.data('context')?.split(' ') || [];
                const $input = $field.find('input, textarea');

                if (fieldContexList.includes(context)) {
                    $field.removeClass('hidden');
                    // Only make required if not ID field during edit mode
                    const isIdField = $input.attr('id') === 'item-id';
                    $input.prop('required', !(isEditMode && isIdField));
                    $input.prop('disabled', isEditMode && isIdField); // Disable ID on edit
                    if (isEditMode && isIdField) {
                         $input.addClass('bg-gray-100 cursor-not-allowed');
                    } else {
                         $input.removeClass('bg-gray-100 cursor-not-allowed');
                    }

                } else {
                    $field.addClass('hidden');
                    $input.prop('required', false); // Not required if hidden
                    $input.prop('disabled', false); // Ensure enabled if shown later
                    $input.removeClass('bg-gray-100 cursor-not-allowed');
                }
            });

            if (isEditMode) {
                populateFormForEdit(context, indices);
            }

            $modal.addClass('active');
            // Focus first visible input field
            $modal.find('input:visible, textarea:visible').first().focus();
        }

        function populateFormForEdit(context, indices) {
             const { branchIndex, semesterIndex, subjectIndex, questionIndex } = indices;
             let itemData = {};
             try {
                 switch(context) {
                    case 'branch': itemData = universityData.branches[branchIndex]; break;
                    case 'semester': itemData = universityData.branches[branchIndex].semesters[semesterIndex]; break;
                    case 'subject': itemData = universityData.branches[branchIndex].semesters[semesterIndex].subjects[subjectIndex]; break;
                    case 'question': itemData = universityData.branches[branchIndex].semesters[semesterIndex].subjects[subjectIndex].questions[questionIndex]; break;
                 }
                 if (!itemData) throw new Error("Item data not found for indices.");
             } catch (e) { console.error("Error retrieving item data for edit:", e); alert("Could not load item data."); closeModal(); return; }

            // Use jQuery's .val() to set form values
            $modalForm.find('#item-id').val(itemData.id || '');
            if(context === 'branch' || context === 'subject') $modalForm.find('#item-name').val(itemData.name || '');
            if(context === 'subject') $modalForm.find('#item-code').val(itemData.code || '');
            if(context === 'semester') $modalForm.find('#item-number').val(itemData.number || '');
             if (context === 'question') {
                $modalForm.find('#item-year').val(itemData.year || '');
                $modalForm.find('#item-qNumber').val(itemData.qNumber || '');
                $modalForm.find('#item-chapter').val(itemData.chapter || '');
                $modalForm.find('#item-text').val(itemData.text || '');
                $modalForm.find('#item-type').val(itemData.type || '');
                $modalForm.find('#item-marks').val(itemData.marks !== undefined ? itemData.marks : '');
            }
        }

        function closeModal() {
            $modal.removeClass('active');
            currentModalContext = null;
            isEditMode = false;
            currentEditIndices = {};
        }

        // --- Form Submission ---
        $modalForm.on('submit', function(event) {
            event.preventDefault();
            const formData = new FormData(this); // 'this' is the form element
            const data = {};

            // Populate data object from visible fields
            $allFormFields.each(function() {
                 const $field = $(this);
                 if (!$field.hasClass('hidden')) {
                     const $input = $field.find('input, textarea');
                     if ($input.length) {
                         const key = $input.attr('name'); // Use name attribute
                         const value = formData.get(key) || '';
                         // Convert numbers where appropriate (safer parsing)
                         if ($input.attr('type') === 'number') {
                             data[key] = parseInt(value, 10);
                             if (isNaN(data[key])) data[key] = 0; // Default to 0 if parse fails
                         } else {
                             data[key] = value;
                         }
                     }
                 }
             });

            const editMode = $modalForm.find('#edit-mode').val() === 'edit';
            const indices = JSON.parse($modalForm.find('#edit-indices').val() || '{}');

            if (editMode) {
                updateItem(currentModalContext, indices, data); // Pass raw form data map
            } else {
                addItem(currentModalContext, indices, data);
            }

            closeModal();
        });

        // --- Data Manipulation (CRUD) ---
         function addItem(context, indices, itemData) {
             // itemData now comes directly from form fields via name attribute
             const { branchIndex, semesterIndex, subjectIndex } = indices;
             try {
                 let newItem;
                 switch (context) {
                    case 'branch':
                         newItem = { id: itemData.id, name: itemData.name, semesters: [] };
                         universityData.branches.push(newItem);
                         break;
                    case 'semester':
                         newItem = { id: itemData.id, number: itemData.number, subjects: [] };
                         universityData.branches[branchIndex].semesters.push(newItem);
                         universityData.branches[branchIndex].semesters.sort((a,b) => a.number - b.number);
                         break;
                    case 'subject':
                         newItem = { id: itemData.id, name: itemData.name, code: itemData.code, questions: [] };
                         universityData.branches[branchIndex].semesters[semesterIndex].subjects.push(newItem);
                         break;
                    case 'question':
                          newItem = {
                              questionId: itemData.id, // Map form 'id' to 'questionId'
                              year: itemData.year, qNumber: itemData.qNumber, chapter: itemData.chapter,
                              text: itemData.text, type: itemData.type, marks: itemData.marks,
                              isCompleted: false // Default completion state
                          };
                          universityData.branches[branchIndex].semesters[semesterIndex].subjects[subjectIndex].questions.push(newItem);
                          break;
                     default: throw new Error(`Invalid context for adding: ${context}`);
                 }
                 renderEditor(); // Re-render everything
             } catch (e) { console.error("Error adding item:", e); alert("Failed to add item."); }
         }

        function updateItem(context, indices, updatedFormData) {
            const { branchIndex, semesterIndex, subjectIndex, questionIndex } = indices;
            try {
                let currentItemRef; // Reference to the object in universityData
                switch (context) {
                    case 'branch': currentItemRef = universityData.branches[branchIndex]; break;
                    case 'semester': currentItemRef = universityData.branches[branchIndex].semesters[semesterIndex]; break;
                    case 'subject': currentItemRef = universityData.branches[branchIndex].semesters[semesterIndex].subjects[subjectIndex]; break;
                    case 'question': currentItemRef = universityData.branches[branchIndex].semesters[semesterIndex].subjects[subjectIndex].questions[questionIndex]; break;
                    default: throw new Error(`Invalid context for updating: ${context}`);
                }

                if (!currentItemRef) throw new Error("Item reference not found for update.");

                // Update properties based on context, preserving nested arrays and ID
                Object.keys(updatedFormData).forEach(key => {
                    // Do not update ID, and skip hidden fields which might be null/undefined
                     if (key !== 'id' && updatedFormData[key] !== undefined && currentItemRef.hasOwnProperty(key)) {
                          // Special mapping for questionId
                          if (context === 'question' && key === 'id') {
                              // This case is skipped by key !== 'id', ID shouldn't change
                          } else if (context === 'question' && key === 'questionId') {
                               // Also skip direct update if 'questionId' somehow comes from form
                          }
                          else {
                              currentItemRef[key] = updatedFormData[key];
                          }
                     } else if (context === 'question' && key === 'id' && currentItemRef.hasOwnProperty('questionId')) {
                          // Map form 'id' back to 'questionId' ONLY IF it exists on the object (should always for questions)
                          // But we generally prevent ID edits. If needed, update logic here carefully.
                          // currentItemRef.questionId = updatedFormData[key]; // Usually disabled
                     }
                });

                 // Re-sort semesters if a semester was updated (number might change)
                 if (context === 'semester') {
                     universityData.branches[branchIndex].semesters.sort((a,b) => a.number - b.number);
                 }

                 renderEditor(); // Re-render
             } catch (e) { console.error("Error updating item:", e); alert("Failed to update item."); }
         }

         function deleteItem(context, indices) {
            const { branchIndex, semesterIndex, subjectIndex, questionIndex } = indices;
             let itemName = `this ${context}`;
             try { // Attempt to get a more descriptive name
                let item;
                if(context === 'branch') item = universityData.branches[branchIndex];
                else if(context === 'semester') item = universityData.branches[branchIndex]?.semesters[semesterIndex];
                else if(context === 'subject') item = universityData.branches[branchIndex]?.semesters[semesterIndex]?.subjects[subjectIndex];
                else if(context === 'question') item = universityData.branches[branchIndex]?.semesters[semesterIndex]?.subjects[subjectIndex]?.questions[questionIndex];

                if(item) itemName = item.name || `Semester ${item.number}` || item.code || `Q# ${item.qNumber}` || item.id || item.questionId || itemName;
             } catch {}

            if (confirm(`Are you sure you want to delete ${itemName}? This cannot be undone.`)) {
                try {
                    switch (context) {
                        case 'branch': universityData.branches.splice(branchIndex, 1); break;
                        case 'semester': universityData.branches[branchIndex]?.semesters.splice(semesterIndex, 1); break;
                        case 'subject': universityData.branches[branchIndex]?.semesters[semesterIndex]?.subjects.splice(subjectIndex, 1); break;
                        case 'question': universityData.branches[branchIndex]?.semesters[semesterIndex]?.subjects[subjectIndex]?.questions.splice(questionIndex, 1); break;
                        default: throw new Error(`Invalid context for deletion: ${context}`);
                    }
                    renderEditor(); // Re-render after delete
                } catch (e) { console.error("Error deleting item:", e); alert("Failed to delete item."); }
            }
        }

        // --- Event Handlers (using delegation) ---

        // Modal Triggers (Add/Edit)
        $('#add-branch-main-btn').on('click', function() { showModal('branch'); });
        $(document).on('click', '.add-semester-btn', function() { showModal('semester', { branchIndex: $(this).data('branch-index') }); });
        $(document).on('click', '.add-subject-btn', function() { showModal('subject', { branchIndex: $(this).data('branch-index'), semesterIndex: $(this).data('semester-index') }); });
        $(document).on('click', '.add-question-btn', function() { showModal('question', { branchIndex: $(this).data('branch-index'), semesterIndex: $(this).data('semester-index'), subjectIndex: $(this).data('subject-index') }); });
        $(document).on('click', '.edit-item-btn', function() { showModal($(this).data('context'), $(this).data('indices')); });

        // Delete Trigger
        $(document).on('click', '.delete-item-btn', function() { deleteItem($(this).data('context'), $(this).data('indices')); });

        // Ask AI Trigger
        $(document).on('click', '.ask-ai-btn', function() {
             try {
                const question = $(this).data('question'); // Retrieve the stringified JSON
                let promptText = `Help me understand or solve this question`;
                if (question.type) promptText += ` (Type: ${question.type})`;
                // ... rest of the prompt building logic ...
                if (question.chapter) promptText += ` about "${question.chapter.replace(/^Module\s*\d+:\s*/i, '').trim()}"`;
                if (question.year) promptText += ` from the ${question.year} exam`;
                if (question.marks) promptText += ` worth ${question.marks} marks`;
                const cleanedText = (question.text || '').replace(QUESTION_ID_REGEX, '').trim();
                promptText += `:\n\n${cleanedText}`;

                const searchQuery = encodeURIComponent(promptText); const url = `https://www.google.com/search?q=${searchQuery}`; window.open(url, '_blank');
            } catch (e) { console.error("Error in Ask AI:", e); alert("Could not process question data for Ask AI."); }
        });

        // Toggle Completion Trigger
        $(document).on('click', '.toggle-completion-btn', function() {
            const indices = $(this).data('indices');
             try {
                const { branchIndex, semesterIndex, subjectIndex, questionIndex } = indices;
                const question = universityData.branches[branchIndex].semesters[semesterIndex].subjects[subjectIndex].questions[questionIndex];
                question.isCompleted = !question.isCompleted;
                // Visually update just the toggle and card border without full re-render
                $(this).find('.toggle-bg').toggleClass('bg-gray-300 bg-green-500');
                $(this).find('.toggle-dot').toggleClass('translate-x-0 translate-x-5');
                $(this).closest('.question-card').toggleClass('border-gray-200 border-l-4 border-green-500');
                updateJsonOutput(); // Update JSON as completion state changes
             } catch (e) { console.error("Error toggling completion:", e); }
        });

        // Modal Cancel/Close
        $('#modal-cancel-btn').on('click', closeModal);
        $modal.on('click', function(event) { // Close on overlay click
            if (event.target === this) closeModal();
        });

        // --- Local Storage ---
        function saveDataToLocalStorage() {
             try { localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(universityData)); alert('Data saved.'); }
             catch (e) { console.error("Error saving:", e); alert('Failed to save.'); }
        }
        function loadDataFromLocalStorage() {
             const savedData = localStorage.getItem(LOCAL_STORAGE_KEY);
             if (savedData) {
                 try {
                     const parsedData = JSON.parse(savedData);
                     // Basic validation/defaulting
                     universityData = { branches: parsedData.branches || [] };
                     // Add default 'isCompleted' if missing (important for toggle logic)
                      universityData.branches.forEach(b => {
                         b.semesters = b.semesters || [];
                         b.semesters.forEach(s => {
                            s.subjects = s.subjects || [];
                             s.subjects.forEach(sub => {
                                 sub.questions = sub.questions || [];
                                 sub.questions.forEach(q => q.isCompleted = q.isCompleted || false);
                             });
                         });
                     });
                     renderEditor(); alert('Data loaded.');
                 } catch (e) { console.error("Error loading:", e); alert('Failed to load data.'); universityData = { branches: [] }; renderEditor();}
             } else { alert('No data found.'); }
        }

        $('#save-local-btn').on('click', saveDataToLocalStorage);
        $('#load-local-btn').on('click', loadDataFromLocalStorage);

        // --- Initial Load ---
        loadDataFromLocalStorage(); // Try loading on startup
        if (!universityData || !universityData.branches || universityData.branches.length === 0) {
             renderEditor(); // Render empty state if no data loaded
        }

    }); // End of $(document).ready()
    </script>
</body>
</html>